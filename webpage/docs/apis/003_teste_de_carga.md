---
sidebar_position: 4
slug: /backend/teste-de-carga
title: "Teste de Carga"
---
<!-- 
## TO-DO

<img src="https://64.media.tumblr.com/1410879ae6d00e77f5dbe27c03f252fc/tumblr_inline_ofgcs4tnDi1r5ight_400.gifv" alt="Gai Sensei and Rock Lee Trainning Smiles and Taijutsu"
style={{ display: 'block', marginLeft: 'auto', maxHeight: '40vh', marginRight: 'auto', marginBottom: '24px' }}></img>
<br /> -->

Pessoal agora vamos pensar em como vamos testar nosso sistema! At√© aqui criamos, mas como vamos testar para ver se tudo est√° funcionando? E se tudo estiver funcionando, at√© quando conseguimos segurar diversos usu√°rios?

## 1. O que √© Teste de Carga?

O teste de carga √© uma t√©cnica de teste de software que visa avaliar o comportamento de um sistema sob condi√ß√µes de carga espec√≠ficas. O objetivo √© verificar se o sistema √© capaz de suportar a carga esperada, garantindo que o mesmo funcione de forma eficiente e eficaz.

> Mas Murilo, quando fazemos uma requisi√ß√£o com o Insomnia, Postman ou at√© mesmo acessamos uma p√°gina web, n√£o estamos realizando um teste de carga?

Sim, de certa forma estamos realizando um teste de carga, por√©m, o teste de carga que estamos falando √© um pouco mais complexo. Ele √© realizado com o intuito de avaliar o comportamento do sistema sob condi√ß√µes de carga espec√≠ficas, como por exemplo, o n√∫mero de usu√°rios simult√¢neos, a quantidade de requisi√ß√µes por segundo, entre outros.

## 2. Por que realizar um Teste de Carga?

O teste de carga √© uma etapa muito importante no ciclo de desenvolvimento de software, pois ele permite avaliar o comportamento do sistema sob condi√ß√µes de carga espec√≠ficas, garantindo que o mesmo funcione de forma eficiente e eficaz.

Al√©m disso, o teste de carga permite identificar poss√≠veis gargalos e problemas de desempenho no sistema, possibilitando a corre√ß√£o dos mesmos antes que o sistema seja disponibilizado para os usu√°rios finais.

## 3. Como realizar um Teste de Carga?

Para realizar um teste de carga, √© necess√°rio seguir os seguintes passos:

1. **Definir os objetivos do teste**: Antes de iniciar o teste, √© importante definir os objetivos que se deseja alcan√ßar com o mesmo. Por exemplo, verificar se o sistema √© capaz de suportar um determinado n√∫mero de usu√°rios simult√¢neos, a quantidade de requisi√ß√µes por segundo, entre outros.

2. **Definir as m√©tricas de avalia√ß√£o**: Ap√≥s definir os objetivos do teste, √© importante definir as m√©tricas que ser√£o utilizadas para avaliar o comportamento do sistema. Por exemplo, tempo de resposta, taxa de erro, entre outros.

3. **Elaborar o plano de teste**: Com os objetivos e m√©tricas definidos, √© necess√°rio elaborar o plano de teste, que consiste em definir as condi√ß√µes de carga que ser√£o aplicadas ao sistema, como por exemplo, o n√∫mero de usu√°rios simult√¢neos, a quantidade de requisi√ß√µes por segundo, entre outros.

4. **Executar o teste**: Ap√≥s elaborar o plano de teste, √© necess√°rio executar o teste, aplicando as condi√ß√µes de carga definidas ao sistema e coletando os resultados obtidos.

5. **Analisar os resultados**: Por fim, √© necess√°rio analisar os resultados obtidos, verificando se o sistema foi capaz de suportar a carga esperada e se o mesmo funcionou de forma eficiente e eficaz.

## 4. M√©tricas de Desempenho

Durante o teste de carga, √© importante avaliar algumas m√©tricas de desempenho que podem indicar poss√≠veis problemas no sistema. Algumas das m√©tricas mais comuns s√£o:

- **Tempo de Resposta**: Tempo que o sistema leva para responder a uma requisi√ß√£o.

- **Taxa de Erro**: Porcentagem de requisi√ß√µes que resultaram em erro.

- **Taxa de Transfer√™ncia**: Quantidade de dados transferidos por segundo.

- **Utiliza√ß√£o de Recursos**: Porcentagem de utiliza√ß√£o dos recursos do sistema, como CPU, mem√≥ria, disco, entre outros.

## 5. Tipos de Teste de Carga

[Tadjudin](https://medium.com/@rico098098) faz uma defini√ß√£o bastante interessante de tipos de teste de carga em seu trabalho [*Load Testing with Python*](https://medium.com/@rico098098/load-testing-with-python-fea13369af43). Vamos avaliar as defini√ß√µes que ele pontua:

### 5.1 Teste de Carga

Verifica como o sistema se comporta sob uma carga espec√≠fica, como por exemplo, o n√∫mero de usu√°rios simult√¢neos, a quantidade de requisi√ß√µes por segundo, entre outros.

<img src="https://miro.medium.com/v2/resize:fit:720/format:webp/1*vylgyAgdatwOn0ZyXj8WpA.png" style={{ display: 'block', marginLeft: 'auto', maxHeight: '40vh', marginRight: 'auto', marginBottom: '24px' }}/>

<p style={{ textAlign:"center", marginBottom:'24px' }}>(Refer√™ncia: [link](https://miro.medium.com/v2/resize:fit:720/format:webp/1*vylgyAgdatwOn0ZyXj8WpA.png))</p>

### 5.2 Teste de Estresse

Verifica como o sistema se comporta sob uma carga extrema, como por exemplo, o n√∫mero m√°ximo de usu√°rios simult√¢neos, a quantidade m√°xima de requisi√ß√µes por segundo, entre outros. O objetivo deste teste √© verificar o limite do sistema e identificar poss√≠veis problemas de desempenho.

<img src="https://miro.medium.com/v2/resize:fit:720/format:webp/1*dyrsK-uyeG0N7tDR0DuXSw.png" style={{ display: 'block', marginLeft: 'auto', maxHeight: '40vh', marginRight: 'auto', marginBottom: '24px' }}/>

<p style={{ textAlign:"center", marginBottom:'24px' }}>(Refer√™ncia: [link](https://miro.medium.com/v2/resize:fit:720/format:webp/1*dyrsK-uyeG0N7tDR0DuXSw.png))</p>

### 5.3 Teste de Estabilidade (Endurance)

Verifica como o sistema se comporta sob uma carga constante, por um longo per√≠odo de tempo. O objetivo deste teste √© verificar se o sistema √© capaz de manter o desempenho ao longo do tempo, identificando poss√≠veis problemas de vazamento de recursos.

<img src="https://miro.medium.com/v2/resize:fit:720/format:webp/1*CtRQh9cGZX2fKTQ85KSNew.png" style={{ display: 'block', marginLeft: 'auto', maxHeight: '40vh', marginRight: 'auto', marginBottom: '24px' }}/>

<p style={{ textAlign:"center", marginBottom:'24px' }}>(Refer√™ncia: [link](https://miro.medium.com/v2/resize:fit:720/format:webp/1*CtRQh9cGZX2fKTQ85KSNew.png))</p>

## 6. Aplica√ß√µes que Ser√£o Testadas

Nesta se√ß√£o pessoal, vamos avaliar as aplica√ß√µes que ser√£o testadas durante nosso estudo sobre os testes de carga. Elas s√£o aplica√ß√µes constru√≠das com alguns frameworks de Python e todas est√£o dockerizadas  üê≥.

Pe√ßo que voc√™s dediquem uma quantidade de tempo para verificar como elas foram desenvolvidas e quais s√£o as diferen√ßas entre elas. Todos os c√≥digos fonte est√£o dispon√≠veis no [reposit√≥rio do GitHub](https://github.com/Murilo-ZC/M10-Inteli-Eng-Comp/tree/main/src/encontro05).

### 6.1 Aplica√ß√µes

Aqui temos um breve descritivo de cada uma das aplica√ß√µes que ser√£o testadas.

### 6.2 Aplica√ß√£o 1 - Flask com SQLite

Essa aplica√ß√£o foi constru√≠da com o framework Flask e utiliza o banco de dados SQLite. Ela √© uma aplica√ß√£o simples que permite a cria√ß√£o de usu√°rios e a listagem de todos os usu√°rios cadastrados.

O CRUD foi implementado utilizando a biblioteca `sqlite3` do Python e comandos SQL. A aplica√ß√£o foi dockerizada e est√° pronta para ser executada. O link para ela pode ser visto [aqui](https://github.com/Murilo-ZC/M10-Inteli-Eng-Comp/tree/main/src/encontro05/aplicacao01).

Um ponto importante para se observar, essa implementa√ß√£o foi deployada com o servidor built-in do Flask, o que n√£o √© recomendado para ambientes de produ√ß√£o.

### 6.3 Aplica√ß√£o 2 - Flask com SQLite e Servidor Gunicorn

Est√° aplica√ß√£o √© igual a anterior, mas utilizando o servidor Gunicorn para servir a aplica√ß√£o. O Gunicorn √© um servidor HTTP WSGI para Python que √© amplamente utilizado para servir aplica√ß√µes web Python em produ√ß√£o.

:::tip[WSGI]

A Interface Gateway de Servidor Web (WSGI) √© uma especifica√ß√£o para a comunica√ß√£o entre servidores web e aplica√ß√µes web Python. Ela define um contrato entre servidores web e aplica√ß√µes web Python, permitindo que diferentes servidores web e aplica√ß√µes web Python se comuniquem de forma eficiente.

Para saber mais sobre o WSGI, acesse a [documenta√ß√£o oficial](https://www.python.org/dev/peps/pep-3333/).
E para saber mais sobre o Gunicorn, acesse a [documenta√ß√£o oficial](https://gunicorn.org/) e sua implementa√ß√£o com o [Flask](https://flask.palletsprojects.com/en/3.0.x/deploying/gunicorn/).
:::

Voc√™ pode acessar o c√≥digo fonte [aqui](https://github.com/Murilo-ZC/M10-Inteli-Eng-Comp/tree/main/src/encontro05/aplicacao02).

### 6.4 Aplica√ß√£o 3 - FastAPI com SQLite

Agora pessoal, vamos para uma aplica√ß√£o constru√≠da com o framework FastAPI. O FastAPI √© um framework moderno e r√°pido para construir APIs web com Python 3.6+ baseado em anota√ß√µes de tipo.

Vamos utilizar a mesma base de c√≥digo da aplica√ß√£o 1, mas agora com o FastAPI. O link para o c√≥digo fonte pode ser acessado [aqui](https://github.com/Murilo-ZC/M10-Inteli-Eng-Comp/tree/main/src/encontro05/aplicacao03).

:::tip[Uvicorn vs Gunicorn]

O Uvicorn √© um servidor ASGI que √© amplamente utilizado para servir aplica√ß√µes web Python em produ√ß√£o. Ele √© o servidor recomendado para servir aplica√ß√µes FastAPI. J√° o Gunicorn √© um servidor WSGI que √© amplamente utilizado para servir aplica√ß√µes web Python em produ√ß√£o. Ele √© o servidor recomendado para servir aplica√ß√µes Flask.

:::

:::tip[ASGI]

A Interface Gateway de Servidor Ass√≠ncrono (ASGI) √© uma especifica√ß√£o para a comunica√ß√£o entre servidores web e aplicativos web Python ass√≠ncronos. Ela define um contrato entre servidores web e aplicativos web Python ass√≠ncronos, permitindo que diferentes servidores web e aplicativos web Python ass√≠ncronos se comuniquem de forma eficiente.

Para saber mais sobre o ASGI, acesse a [documenta√ß√£o oficial](https://asgi.readthedocs.io/en/latest/).
E para saber mais sobre o Uvicorn, acesse a [documenta√ß√£o oficial](https://www.uvicorn.org/).

:::

### 6.5 Considera√ß√µes 

Pessoal ainda podemos criar diferentes aplica√ß√µes para testar. Essas s√£o apenas algumas aplica√ß√µes base que utilizam diferentes frameworks de Python.

:::danger[IMPORTANTE]

Pessoal, repare que, mesmo com frameworks diferentes, as aplica√ß√µes tem as demais caracter√≠sticas iguais. Isso √© proposital para que possamos avaliar o desempenho de cada framework. Quando iniciarmos as trocas de pontos das tecnologias, devemos lembrar que elas podem impactar na performance da aplica√ß√£o.

Se estamos comparando apenas os frameworks, devemos manter as demais caracter√≠sticas iguais.

:::

## 7. Ferramentas de Teste

Pessoal agora vamos falar sobre as ferramentas de teste que ser√£o utilizadas para avaliar as aplica√ß√µes que foram constru√≠das. Cada ferramenta apresentada aqui tem suas particularidades e √© importante entender como elas funcionam.

Nosso objetivo ser√° compreender como elas s√£o utilizadas. Vamos realizar todos os testes na aplica√ß√£o 1. A compara√ß√£o com as demais aplica√ß√µes fica como tarefa de implementa√ß√£o de voc√™s.

### 7.1 Locust

O Locust √© uma ferramenta de teste de carga de c√≥digo aberto que permite que voc√™ escreva cen√°rios de teste em Python. Ele √© altamente escal√°vel e pode ser usado para testar aplica√ß√µes web, APIs e outros sistemas. Sua documenta√ß√£o oficial pode ser acessada [aqui](https://locust.io).

Vamos testar nossa aplica√ß√£o 1 com o Locust. Para isso, vamos seguir os seguintes passos:

```bash
# criar um venv
python3 -m venv venv
# ativar o venv
source venv/bin/activate
# instalar o locust
pip install locust
```

Agora vamos criar um arquivo chamado `locustfile.py` com o seguinte conte√∫do:

```python
from locust import HttpUser, task, between

class WebsiteUser(HttpUser):
    wait_time = between(1, 5)

    @task
    def criar_usuario(self):
        self.client.post("/usuarios", json={"nome": "Fulano",  "email": "mail@mail.com" })

    @task
    def pegar_usuarios(self):
        self.client.get(f"/usuarios")
```

Agora no terminal execute a aplica√ß√£o com o comando:

```bash
locust -f locustfile.py
```

Acesse o endere√ßo `http://localhost:8089` e configure o n√∫mero de usu√°rios e a taxa de requisi√ß√µes. Depois clique em `Start Swarming` para iniciar o teste.


---

## 8. Recomenda√ß√µes de V√≠deo

<iframe width="560" height="315" src="https://www.youtube.com/embed/KECr2BujqtM?si=oRaHu1C62bQQf0GE" style={{ display: 'block', marginLeft: 'auto', maxHeight: '40vh', marginRight: 'auto', marginBottom:'24px' }}></iframe>

<iframe width="560" height="315" src="https://www.youtube.com/embed/RiM1GsVSbzM?si=e4IITWxzQxbbHXCo" style={{ display: 'block', marginLeft: 'auto', maxHeight: '40vh', marginRight: 'auto', marginBottom:'24px' }}></iframe>

---

## 9. Proxy e Proxy Reverso

Pessoal vamos analisar aqui um caso um pouco mais completo agora. Vamos ter nossa API primeiro rodando com o Flask e se conectando em um banco de dados SQLite. Mas vamos servir ela de uma maneira diferente para a aplica√ß√£o. Vamos colocar um proxy reverso na frente dela. 

> "Calma l√° Muril√£o, vamos colocar o que?"

Um Proxy Reverso √© um servidor que fica entre o cliente e a nossa aplica√ß√£o. Ele √© utilizado para gerenciar como as requisi√ß√µes externas chegam at√© nossa aplica√ß√£o interna. Com ele, conseguimos manter nossa aplica√ß√£o rodando com comunica√ß√£o HTTP internamente, enquanto usamos HTTPS externamente, com certificados SSL sendo gerenciados no proxy.

> "Murilo, pera ai, o que √© um proxy ent√£o?"

Boa pergunta! Um proxy comum √© uma forma de interceptar conex√µes de sa√≠da em uma rede. Ele atua em nome do cliente, repassando requisi√ß√µes internas para a internet, aplicando pol√≠ticas como controle de acesso, autentica√ß√£o ou caching. J√° o proxy reverso faz o caminho contr√°rio: ele recebe requisi√ß√µes externas e as encaminha para os servidores internos.

| Caracter√≠stica     | Proxy (normal)            | Proxy Reverso            |
| ------------------ | ------------------------- | ------------------------ |
| Quem configura     | O cliente                 | O servidor               |
| Esconde quem?      | O cliente (usu√°rio final) | O servidor (backend/API) |
| Protege quem?      | O cliente                 | O servidor               |
| Exemplo t√≠pico     | Acesso controlado √† web   | Balanceamento de carga   |
| Ferramentas comuns | Squid, TinyProxy          | NGINX, HAProxy, Traefik  |


:::tip[Proxy e Proxy Reverso]

<iframe width="560" height="315" src="https://www.youtube.com/embed/4NB0NDtOwIQ?si=yUN9vP96KAqxk6UT" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen style={{ display: 'block', marginLeft: 'auto', maxHeight: '40vh', marginRight: 'auto', marginBottom: '24px' }}></iframe>
<br />

<iframe width="560" height="315" src="https://www.youtube.com/embed/ngoEzjnJ2Eo?si=t2Q0eLI7wGlcdcho" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen style={{ display: 'block', marginLeft: 'auto', maxHeight: '40vh', marginRight: 'auto', marginBottom: '24px' }}></iframe>
<br />

:::

Legal, agora que falamos dele, vamos configurar!! Vamos fazer isso utilizando uma ferramenta chamada [Nginx](https://nginx.org/).

## 10. Exemplo de uso de Proxy Reverso

Vamos trabalhar com a aplica√ß√£o em Python:

```python
# app.py

```